\chapter{Smart Contract and Distributed Ledger Technology}

\section{Ledger} 
Ledger is a book or computer that records transaction associated with a financial system. There are two different ledgers as bellow: \\
\textbf{Centralized Ledger} contains all recording transaction related to company assets, costs, libraries, etc. \\
\textbf{decentralized Ledger } is a database that shares data across the network. It allows to transaction to be executed in public. Any participant of each node can have a identical copy of the ledger which already shared on network.\\
If any change or update occurs on ledger, each node construct new transition and vote by the consensus algorithm to choose correct copy of ledger. Once the consensus has been done, other nodes will synchronize with the latest version of ledger\cite{Markos}.

\subsection{Distributed Vs. Decentralized } 
the difference between decentralized and distributed is made by Baran(1964). decentralized means there is no single point to make a decision. Each node makes up a decision for own self and the system gathers all responses as resulting behavior. However, there is no single point in distributed system too, but the process spread across all nodes and decisions will be centralized. The main difference between distributed and decentralized is that a decentralized database is the collection of inter-connected databases works independently. \textit{Ozsu and Valduriez} define a distributed database as a "collection of multiple, logically interrelated databases distributed over a computer network and distributed database makes a transparent distribution to all users"\cite{Ozsu}. Based on this definition Blockchain technology covers both definitions, as it appears as a single system to its users and performs a task across a network. Thus, Blockchain is a form of a distributed database system.\cite{Markos}.


\section{Distributed Ledger Technology(DLT)} 
DLT refers to a database that provides identical copies of shared data among participants which would be updated by consensus of the participants. \\
DLT is the well-known technology due to complexity of consensus mechanism, which make it easy to implement. 
DLT is utilized to reduce the costs and increase transparently, traceability and speed of process.\\
This technology is involved many challenges that some of  them are not resolved so far. The most commonly challenges rebuild to DLT concern scalability, inseparability, data privacy\cite{Ugarte}. 

\subsection{How DLT works?}
DLT is result of combining main three technologies:\\
\hspace{1cm}\textit{-  P2P}: all participants(nodes) acts simultaneously as client and server, consuming and contributing resources.\\
\hspace{1cm}\textit{- Cryptography} is used to authenticate the identity of the participant and the information between the two parties. Using encryption helps prevent third parties from accessing information. \\
\hspace{1cm}\textit{- Consensus algorithm} allows network participants to come into agreement to add a new node (block) to the ledger\cite{Ugarte}.\\
\section{Blockchain} According to what World Bank Group in their book referred, blockchain is the most popular distributed ledger that stores and publishes data in packages called "blocks". Each block contains information such as nonce, timestamp, block hash and hash pointer to the previous block in own header. Therefore, all these blocks are connected to each other in a digital chain\cite{DLT}. \\
Luke\cite{Luke}, refers to blockchain as a list of blocks that are linked to each other and secured cryptography. The participants on networks have a identical copy of these records stored locally on computers of all participants. Blockhain start processing, when  user request transaction whether is transaction, contract, or other information. Th transaction is broadcast on \textit{P2P} network of nodes. Following that, the verification process takes place where all of the nodes in P2P network verify the transactions via the hashes which are  generated by some algorithm. Once verification completed, transaction detail will stored into a block. Finally, new block is added to a chain in a way that is permanent and unchangeable\cite{Luke}. Th initial block in blockchain known as \textit{Genesis} block, the other nodes will be added to chain after process of consensus between nodes. Consensus mechanism allows the blockchain to grows without  fearing of manipulating information of blocks. Since the blocks contain transaction, consensus process take place in a predefined time interval. This interval is a duration of when initiation of transaction took place and addition of transaction into a blockchain. This confirmation time is varied based on block size, transaction and consensus algorithm. There are different methods for consensus mechanism as bellow: 
\begin{itemize}
    \item Proof of Work (PoW): 
    It is a mechanism that ensures consensus is done without any central control. With POW miners compete to complete its transaction first into blockchain and get rewards(e.g: Bitcoin, Ether).\\
    Miners(actors who participate in cryptocurrency transactions) connected to blockchain and accomplish task validating transactions to add new block by solving a cryptographic puzzle and anybody who complete own task sooner can add own block first in blockchain\cite{Pablo}.
    \item Proof of Stack (PoS): 
    It is an alternative to proof-of-work that fewer CPU computations for mining. In proof of stack, the chance of mining the next block depends on node balance. 
    In private networks, however, where the participants know each other, consensus mechanisms such as proof-of-work are not required. This particularly removes the need for mining and give us more variety of consensus protocol for picking from\cite{Christidis}.
    \item Proof of Authority: It confirms accounts and allow them to add transaction in blocks. As this approach is mush centralised and transaction speed is faster, is prone to be attacked more then the other methods \cite{Luke}.
    \item Proof of Stake: Blockchain try to solve the problem called 'Byzantine Generals' that refers to some members on network who send incoherent information related to transaction to the others. Since there is no authority on blockchain to correct them, leads to unreliability of blockchain. The Practical Byzantine Fault Tolerance (PBFT) algorithm try to achieve some algorithm to solve this issue in  way that uses the concept of primary and secondary "duplicates". Secondary copies automatically evaluate the decisions made by primitive and can collectively change to a primitive, if Primary is compromised \cite{Luke}.
\end{itemize}
Blockchain is associate with cryptocurrany like etheruem , bitcoin, litecoin, etc. Gupta (2017) identified five core attributes that blockchain builds trust through them:
\begin{itemize}
    \item distributed ledger: the data is not controlled by any single authority. the data is shared, updated across network and the new changes will be replicated to all participants.
    \item Orchestrated and flexible: Since smart contract can be executed on blockchain. The blockchain can be evolve to support business process and activities.
    \item Transparent and auditable: There is no need to third party or an other authority, as all participants have access to same ledger, verify transaction and identify the owner. 
    \item Secure, private, and indelible:
    Blockchain provides these feature using some capability such as Permissions and cryptography which ensures that  
    unauthorized users do not any access to network. It means that participates are really who they claim.
    \item consensus: all nodes on network should come to agreement to validate transition and blockchain preform this process by consensus algorithm \cite{Gupta}.
\end{itemize}

\subsection{Type of Blockchian}
According to Athital\cite{Athital} blockchain is used to transfer and exchange information through the secure network. Primarily, there was two type of blockchain technology public and private network. Regarding to some analysis on blockchain technology can also be called blockchain as consortium blockhcain technology and hybrid blockchain technology. \\
That should be noted that all kind of blockchain consist of nodes and works on \textit{P2P} network. Athital \cite{Athital} classified blockcian into three types as bellow: public blockchain, private blockchain and consortium blockchain. Besides this, there is another type of blockchain, known as hybrid blockchain.
\begin{itemize}
    \item \textbf{Public Blockchain}
    This system allows anyone to join to network and create consensuses such as Bitcoin and Ethereum. In a permissionless blockchain, any miner can create consensus mechanisms such as proof of work, proof of stack to validate the transaction. But as this mechanism is permissionless, it has a low rate of validity function\cite{Kalra}.
    \item \textbf{Private Blockchain}: This system, the only restricted participant has the right to validate the transaction. Therefore, it provides better privacy, improve  scalability and mitigate security issues. Unlike permissionless blockchain, this blockchain does not have mining computation to reach the consensus because all participants are known in this network\cite{Kalra}. 
    \item \textbf{Consortium Blockchain}: This is semi-decentralized blockchain. This type of blockchain is used to do activities for single organization like bank, government organization, etc. The different between private blockchin with this type is that Consortium Blockchain is controlled by group rather then single authority \cite{Athital}.
    \item \textbf{Hybrid Blockchain}: this type is combination of public and private blockcain. hus, it exploit the privacy benefit of private blockchain in combined with security, transparency of public blockchain. In this type of blockchain, user can control who get access to which data on blockchain. A transaction can be verified in private network, and user can release it to public blockchain. By doing so, only selected section of records can be allowd to be public and the rest could still maintain confidential in private network\cite{Athital}. 
\end{itemize}

 \section{Ethereum}
 Ethereum is the most active public blockchain in the world at
present. It is another cryptocurrency similar to Bitcoin that built on the top of the blockchain. the participant publishes the transaction on the network that is then divided into a node (called the miner) and add to the blockchain using a consensus mechanism. The state of the system refers to the sate of account that can be an external account related to the user of the system(that contains information about balance) or contract account that obtain contract code or constant storage of that account. The virtual currency in this system is \textit{Ether}. The transaction can change the state of the system by creating a new contract or invoking an existing contract. calling the external account just transfer the Ether but calling the contract account to execute the code of that contract and may perform a transaction or change the storage of that account\cite{Ilya}.

\section{How Ethereum works?}
In this subsection, we will focus on the ethereum  workflow in technical level.
\subsection{Blockchain}
Blockchain contains some information that we have used in our project, that's why we focus on them more as bellow:
\begin{itemize}
    \item \textbf{Block}
    The data stored in block contains different functions which includes transaction hashes and some other additional information for blockchain technology. \textit{Gavin Wood} described some relevant information as bellow and we used this information in out project: \\
    \begin{itemize}
        \item \textit{parentHash}: The hash of the parent blockâ€™s header.
        \item \textit{sateRoot}: The hash of the root node of the state, after transactions are executed.
        \item \textit{transactionRoot}:The hash of the root node of data populated with a transaction in the transactions list inside block.
        \item \textit{receiptRoot}: The hash of the root node of the data populated with the receipts of transaction in the block.
        \item \textit{logsBloom} composed of log information.
        \item \textit{difficulty} represent the difficulty level of the block.
        \item \textit{number} is the number of ancestor blocks.
        \item \textit{gasLimit} represents the current limit of gas in the block.
        \item \textit{gasUsed} is the amount of gas used for transaction in the block.
        \item \textit{timestamp}
        \item \textit{extraData} is an byte array containing relevant information in the block.
        \item \textit{nonce} is a number of computations have been done in the block.
    \end{itemize}
    \item \textbf{mining}
    It is a process of computation on the blockchain to verify and add a block. Miner adds a new block and others check the validity of the new block. Any participant can take part in the mining pool, But the chance of finding valid depends on the power of the computer to perform calculations. Sometimes a miner will find an uncle block; an uncle block is a block that is initially valid but is surpassed by another faster block. Uncle block is rewarded with $\frac{7}{8}$ of full block value and hash will be added to a valid block. A max of two uncle blocks can add to valid block and the miner of the valid block also receive $\frac{1}{32}$ extra ether for each uncle block\cite{Egbertsen}.
    \item \textbf{mining pool}
     Mining can be done alone or in the mining pool. A mining pool is a better way to solve a block and get rewards as compared to mining alone. Miner in pool mine together and rewards will split to all members in pool\cite{Egbertsen}.
\end{itemize}
\subsection{Ether}
 Is the form of payment and as fuel for Ethereum. The base fo mining(find the solution and add block) successfully mining block is five ether. If the miner finds a solution but not fast, it becomes less ether like 4.375 ether and will be uncle block. Each block can contain just two uncle blocks and receive $\frac{1}{32}$ per uncle block. If another miner also finds a solution. this block can not be added into blockchain and miner just receives 2-3 ether\cite{Egbertsen}. 
\subsection{Account}
There are two types of accounts in Ethereum:\\
- \textit{Normally controlled} is an account controlled
by the private key. if Person has the private key can send message and ether from this account.\\
- \textit{Contract} is an account controlled by code. It is a normal account with an extra option of containing code. Ethereum blockchain starts firing transactions from an account in which this transaction is the response of receiving transactions by an account\cite{Egbertsen}. An account consist of four fields:\\
 \begin{itemize}
     \item \textit{nonce} is the number of transactions sent from this address \cite{Gavin}.
     \item \textit{balance} is the number of Wei owned by this address\cite{Gavin}.
     \item \textit{storageRoot} is the has of root node of merkle Patrica tree which encodes the content of an account. It should be also not that merkle tree is use for data representation in block header\cite{Gavin}.
     \item \textit{codeHash}
     The hash associated to this account would be executed, when this account address receive a message call and would not be changeable any more. All information of this account are stored in database are under corresponding hash code for later retrieval. \\
    
\end{itemize}
\textbf{Hash function}  is used in blockchain to ensure the data integrity. The hash functions are able to mapping the arbitrary size input to fixed size output as hash. SHA-3 is the lastest member of SHA family which initially known as \textit{kecak} that become kernel of SHA-3 family and then later its 256 and 512 versions were adopted as hash function of ethereum blockcain \cite{Dilhara}.\\
\textbf{Gas} Transaction in Etheruem platform needs fuel to execute called gas which is used internally and paid in advance to execute a transaction. If the transaction gets run off gas, means the transaction is executed. If transaction rolled back but consumed gas will not be returned.\\
To enable easier calculations, Ether also has some sub-denominations\cite{Egbertsen}:\\
\begin{itemize}
	\item Wei - $10^0$
	\item Szabo - $10^12$
	\item Finney - $10^15$
	\item Ether - $10^18$
\end{itemize}
\begin{itemize}
    \item \textbf{Transaction}
     \textit{Gavin Wood} decribed transcation a cryptography-signed instruction whihch is executed by an extrnal actor. external cator can be human or another contracts. transaction describes these fields:
     \begin{itemize}
         \item \textit{nonce} is the number of transaction send be sender.
         \item \textit{gasPrice} is the number of Wei to be paid per unit of gas for transaction execution.
         \item \textit{gasLimit} is amount of gas should be used to execute transaction.
         \item \textit{to} is address who contract send transaction to.
         \item \textit{value} is the number of Wei which is transferred in transaction.
     \end{itemize}
        \item \textbf{Message}
        As already said blockchain fire transaction when receiving a transaction. When an account sends a transaction means sending a message. The message contains all attributes the same as a transaction, but $gasPrice$. the only difference between message and transaction is that message is fired by contract\cite{Egbertsen}.
\end{itemize}
\subsection{Contracts}  is an account in the etheruem blockchian having its own code and controlled by code. The code inside contract is triggered whenever it receives a massage, allowing to read and write contract storage or send massage. \\
Contract in ethereum is an autonomous agent that preform some operations which are programmed to fulfill user's goals, meaning that contract is an alive autonomous agent which is executed when it receives a message or transaction,  having control over own balance and the key /value store to constant variables .
the key and values stored in contract is long lasting and get used whenever contract start running \cite{Egbertsen}.

\subsection{smart contract}
 The term smart contract was coined in 1994 by Nick Szabo who released that DLT can be used fro smart contract. 
According to Nick Szabo \textit{A smart contract is a computerized transaction protocol that executes the terms of a contract}\footnote{https://www.fon.hum.uva.nl/rob/Courses/InformationInSpeech/CDROM/Literature/LOTwinterschool2006/szabo.best.vwh.net/smart.contracts.html}. He visualized a away  to write agreement which enforce the conditions between parties involve in transaction automatically and more efficiently.
Smart contract run by each node as part of block creation process. Block creation means when transaction take place in the block.
An important part of smart contract is the each contract has own address. Since the contract code is con carried to the transaction, node can create  spacial transaction, assigning address to contract, then this transaction is capable to run contract code at the time of creation.\\
After that the contract will be as part of block and address will never change. whenever, node want to call method inside contract, should send message to address of contract having method and input data.
the contract will run as the part of creation of new block, then return value or store data in blockchain. \cite{Payrott}.

\textbf{Solidity} is high-level truing complete language with Java script similar syntax. The contract is similar to classes in an object-oriented language which contains the fields as persistent storage of contracts and methods to be invoked by internal and external transactions. For interacting with another contract, either need to create a new instance of this contract or make a transaction to a known contract address.\\
In principle, Solidity provides some basics to access blocks and transactions details like: \textit{msg:sender} for accessing the address of an account or \textit{msg:value} to access the amount of \textit{wei} transferred by transaction. Solidity uses some functions to transfer money to another contracts such as \textit{call} and \textit{send}. This function get used to transfer value , and translate as internal call to transaction which cause to call contract also execute code or may fail to execute due to insufficient gas \cite{Ilya}.

